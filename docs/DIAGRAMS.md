# Cleanup CLI - 架构图和流程图

## 1. 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                          CLI Layer (cmd/cleanup)                     │
│                                                                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐           │
│  │  scan    │  │ organize │  │   junk   │  │  undo    │           │
│  │ command  │  │ command  │  │ command  │  │ command  │           │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘           │
│       │             │              │              │                  │
└───────┼─────────────┼──────────────┼──────────────┼─────────────────┘
        │             │              │              │
        ▼             ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Business Logic Layer                            │
│                                                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │   Analyzer   │  │  Organizer   │  │   Cleaner    │             │
│  │              │  │              │  │              │             │
│  │ • Scan files │  │ • Plan ops   │  │ • Scan junk  │             │
│  │ • Detect type│  │ • Execute    │  │ • Classify   │             │
│  │ • Assess name│  │ • Conflict   │  │ • Clean safe │             │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘             │
│         │                  │                  │                      │
│  ┌──────┴───────┐  ┌──────┴───────┐  ┌──────┴───────┐             │
│  │ Rules Engine │  │ Transaction  │  │ Visualizer   │             │
│  │              │  │   Manager    │  │              │             │
│  │ • Match rules│  │ • Begin/     │  │ • Tree view  │             │
│  │ • Priority   │  │   Commit     │  │ • Diff view  │             │
│  │ • Apply      │  │ • Rollback   │  │ • Summary    │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
│                                                                       │
└───────────────────────────────────┬───────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Infrastructure Layer                             │
│                                                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │  AI Client   │  │   Config     │  │   Output     │             │
│  │              │  │   Manager    │  │              │             │
│  │ • Ollama     │  │ • Load/Save  │  │ • Console    │             │
│  │ • OpenAI     │  │ • Validate   │  │ • Style      │             │
│  │ • Suggest    │  │ • Defaults   │  │ • Format     │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
│                                                                       │
│  ┌──────────────┐  ┌──────────────┐                                │
│  │  Template    │  │  File System │                                │
│  │   Engine     │  │              │                                │
│  │ • Expand     │  │ • Read/Write │                                │
│  │ • Placeholders│  │ • Move/Rename│                                │
│  └──────────────┘  └──────────────┘                                │
└─────────────────────────────────────────────────────────────────────┘
```

## 2. 文件整理流程图

```
                    ┌─────────────┐
                    │   Start     │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ Scan Files  │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ Analyze     │
                    │ Metadata    │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ Assess      │
                    │ Filename    │
                    └──────┬──────┘
                           │
                    ┌──────┴──────┐
                    │ Meaningless?│
                    └──────┬──────┘
                           │
                    ┌──────┴──────┐
                    │     Yes     │ No
                    ▼             ▼
            ┌──────────────┐  ┌──────────────┐
            │ AI Rename    │  │ Keep Name    │
            └──────┬───────┘  └──────┬───────┘
                   │                 │
                   └────────┬────────┘
                            │
                            ▼
                    ┌──────────────┐
                    │ Document?    │
                    └──────┬───────┘
                           │
                    ┌──────┴──────┐
                    │     Yes     │ No
                    ▼             ▼
            ┌──────────────┐  ┌──────────────┐
            │ AI Categorize│  │ Skip Category│
            └──────┬───────┘  └──────┬───────┘
                   │                 │
                   └────────┬────────┘
                            │
                            ▼
                    ┌──────────────┐
                    │ Match Rules  │
                    └──────┬───────┘
                           │
                           ▼
                    ┌──────────────┐
                    │ Generate Plan│
                    └──────┬───────┘
                           │
                           ▼
                    ┌──────────────┐
                    │ Show Preview │
                    └──────┬───────┘
                           │
                    ┌──────┴──────┐
                    │  Dry Run?   │
                    └──────┬──────┘
                           │
                    ┌──────┴──────┐
                    │     Yes     │ No
                    ▼             ▼
            ┌──────────────┐  ┌──────────────┐
            │   Exit       │  │ Execute Plan │
            └──────────────┘  └──────┬───────┘
                                     │
                                     ▼
                              ┌──────────────┐
                              │ Record Txn   │
                              └──────┬───────┘
                                     │
                                     ▼
                              ┌──────────────┐
                              │ Show Results │
                              └──────┬───────┘
                                     │
                                     ▼
                              ┌──────────────┐
                              │    End       │
                              └──────────────┘
```

## 3. 规则匹配流程

```
┌─────────────┐
│  File       │
│  Metadata   │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────┐
│  For each rule (by priority desc)   │
└──────┬──────────────────────────────┘
       │
       ▼
┌─────────────┐
│ Check       │
│ Condition   │
└──────┬──────┘
       │
       ├─────────────┬─────────────┬─────────────┐
       │             │             │             │
       ▼             ▼             ▼             ▼
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│Extension │  │ Pattern  │  │   Size   │  │   Date   │
│  Match   │  │  Match   │  │  Match   │  │  Match   │
└────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
     │             │             │             │
     └─────────────┴─────────────┴─────────────┘
                   │
                   ▼
            ┌──────────────┐
            │   Matched?   │
            └──────┬───────┘
                   │
            ┌──────┴──────┐
            │     Yes     │ No
            ▼             ▼
     ┌──────────────┐  ┌──────────────┐
     │ Add to       │  │ Try Next     │
     │ Matched List │  │ Rule         │
     └──────┬───────┘  └──────┬───────┘
            │                 │
            └────────┬────────┘
                     │
                     ▼
              ┌──────────────┐
              │ More Rules?  │
              └──────┬───────┘
                     │
              ┌──────┴──────┐
              │     Yes     │ No
              ▼             ▼
       ┌──────────────┐  ┌──────────────┐
       │ Continue     │  │ Return       │
       │ Loop         │  │ Matched List │
       └──────────────┘  └──────────────┘
```

## 4. 事务管理流程

```
┌─────────────┐
│ Begin Txn   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Execute Op  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Create      │
│ Backup      │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Perform     │
│ Operation   │
└──────┬──────┘
       │
       ├─────────────┐
       │ Success?    │
       └──────┬──────┘
              │
       ┌──────┴──────┐
       │     Yes     │ No
       ▼             ▼
┌──────────────┐  ┌──────────────┐
│ Record Op    │  │ Restore      │
│              │  │ Backup       │
└──────┬───────┘  └──────┬───────┘
       │                 │
       ▼                 ▼
┌──────────────┐  ┌──────────────┐
│ More Ops?    │  │ Return Error │
└──────┬───────┘  └──────────────┘
       │
┌──────┴──────┐
│     Yes     │ No
▼             ▼
┌──────────────┐  ┌──────────────┐
│ Continue     │  │ Commit Txn   │
│ Loop         │  │              │
└──────────────┘  └──────┬───────┘
                         │
                         ▼
                  ┌──────────────┐
                  │ Persist Log  │
                  └──────┬───────┘
                         │
                         ▼
                  ┌──────────────┐
                  │ Clean Backup │
                  └──────┬───────┘
                         │
                         ▼
                  ┌──────────────┐
                  │ Return       │
                  │ Success      │
                  └──────────────┘
```

## 5. AI 集成流程

```
┌─────────────┐
│ File Needs  │
│ AI Analysis │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Generate    │
│ Prompt      │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Add Context │
│ (content,   │
│  metadata)  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Call AI     │
│ Service     │
└──────┬──────┘
       │
       ├─────────────┐
       │ Provider?   │
       └──────┬──────┘
              │
       ┌──────┴──────┐
       │             │
       ▼             ▼
┌──────────────┐  ┌──────────────┐
│   Ollama     │  │   OpenAI     │
│   (Local)    │  │   (Cloud)    │
└──────┬───────┘  └──────┬───────┘
       │                 │
       └────────┬────────┘
                │
                ▼
         ┌──────────────┐
         │ Parse        │
         │ Response     │
         └──────┬───────┘
                │
                ▼
         ┌──────────────┐
         │ Clean &      │
         │ Validate     │
         └──────┬───────┘
                │
                ▼
         ┌──────────────┐
         │ Return       │
         │ Suggestion   │
         └──────────────┘
```

## 6. 系统清理流程

```
┌─────────────┐
│ Start Scan  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Get Junk    │
│ Locations   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ For Each    │
│ Location    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Scan Files  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Classify    │
│ File        │
└──────┬──────┘
       │
       ├─────────────┬─────────────┬─────────────┐
       │             │             │             │
       ▼             ▼             ▼             ▼
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│  Cache   │  │   Logs   │  │   Temp   │  │  Trash   │
└────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
     │             │             │             │
     └─────────────┴─────────────┴─────────────┘
                   │
                   ▼
            ┌──────────────┐
            │ Important?   │
            └──────┬───────┘
                   │
            ┌──────┴──────┐
            │     Yes     │ No
            ▼             ▼
     ┌──────────────┐  ┌──────────────┐
     │ Skip File    │  │ Add to List  │
     └──────────────┘  └──────┬───────┘
                              │
                              ▼
                       ┌──────────────┐
                       │ Show Preview │
                       └──────┬───────┘
                              │
                              ▼
                       ┌──────────────┐
                       │ Interactive? │
                       └──────┬───────┘
                              │
                       ┌──────┴──────┐
                       │     Yes     │ No
                       ▼             ▼
                ┌──────────────┐  ┌──────────────┐
                │ Prompt User  │  │ Auto Clean   │
                └──────┬───────┘  └──────┬───────┘
                       │                 │
                       └────────┬────────┘
                                │
                                ▼
                         ┌──────────────┐
                         │ Clean File   │
                         └──────┬───────┘
                                │
                         ┌──────┴──────┐
                         │   Force?    │
                         └──────┬──────┘
                                │
                         ┌──────┴──────┐
                         │     Yes     │ No
                         ▼             ▼
                  ┌──────────────┐  ┌──────────────┐
                  │ Delete       │  │ Move to      │
                  │ Permanently  │  │ Trash        │
                  └──────┬───────┘  └──────┬───────┘
                         │                 │
                         └────────┬────────┘
                                  │
                                  ▼
                           ┌──────────────┐
                           │ Record Txn   │
                           └──────┬───────┘
                                  │
                                  ▼
                           ┌──────────────┐
                           │ Show Results │
                           └──────────────┘
```

## 7. 数据流图

```
┌──────────────────────────────────────────────────────────────┐
│                        User Input                             │
│  (Command Line Args, Config File, Interactive Commands)      │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│                     Configuration                             │
│  • Rules                                                      │
│  • AI Settings                                                │
│  • Exclusions                                                 │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│                    File Scanning                              │
│  Input: Directory Path                                        │
│  Output: [FileMetadata]                                       │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│                    AI Analysis (Optional)                     │
│  Input: FileMetadata                                          │
│  Output: Suggestions (Name, Category)                        │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│                    Rule Matching                              │
│  Input: FileMetadata + Rules                                 │
│  Output: Matched Rules                                        │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│                    Plan Generation                            │
│  Input: FileMetadata + Matched Rules                         │
│  Output: OrganizePlan                                         │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│                    Plan Execution                             │
│  Input: OrganizePlan                                          │
│  Output: BatchResult                                          │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│                    Transaction Log                            │
│  • Operation Records                                          │
│  • Backup Paths                                               │
│  • Timestamps                                                 │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│                    Output Display                             │
│  • Summary                                                    │
│  • Diff View                                                  │
│  • Transaction IDs                                            │
└──────────────────────────────────────────────────────────────┘
```

## 8. 模块依赖图

```
                    cmd/cleanup/main.go
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
   organizer          analyzer           cleaner
        │                  │                  │
        ├──────────┬───────┼───────┬──────────┤
        │          │       │       │          │
        ▼          ▼       ▼       ▼          ▼
     rules    transaction  ai   visualizer  output
        │          │       │       │          │
        └──────────┴───────┴───────┴──────────┘
                           │
                           ▼
                       config
                           │
                    ┌──────┴──────┐
                    │             │
                    ▼             ▼
                 ollama        template
```

## 9. 并发模型

```
Main Goroutine
    │
    ├─> Scan Files (Sequential)
    │
    ├─> AI Analysis (Concurrent)
    │   ├─> Worker 1 ──> AI Request
    │   ├─> Worker 2 ──> AI Request
    │   ├─> Worker 3 ──> AI Request
    │   └─> Worker 4 ──> AI Request
    │
    ├─> Execute Operations (Concurrent)
    │   ├─> Worker 1 ──> Move/Rename
    │   ├─> Worker 2 ──> Move/Rename
    │   ├─> Worker 3 ──> Move/Rename
    │   └─> Worker 4 ──> Move/Rename
    │
    └─> Display Results (Sequential)
```

## 10. 错误处理流程

```
┌─────────────┐
│ Operation   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Try Execute │
└──────┬──────┘
       │
       ├─────────────┐
       │   Error?    │
       └──────┬──────┘
              │
       ┌──────┴──────┐
       │     Yes     │ No
       ▼             ▼
┌──────────────┐  ┌──────────────┐
│ Wrap Error   │  │ Continue     │
│ with Context │  │              │
└──────┬───────┘  └──────────────┘
       │
       ▼
┌──────────────┐
│ Recoverable? │
└──────┬───────┘
       │
┌──────┴──────┐
│     Yes     │ No
▼             ▼
┌──────────────┐  ┌──────────────┐
│ Log Error    │  │ Rollback     │
│ Continue     │  │ Return Error │
└──────────────┘  └──────────────┘
```

这些图表展示了 Cleanup CLI 的核心架构、流程和数据流，帮助理解系统的整体设计和各模块之间的关系。
